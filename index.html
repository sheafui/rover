<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rover Plugin</title>

    <script src="./dist/cdn.js"></script>
    <link rel="icon" href="data:,">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>

<body class="flex mt-20 justify-center bg-neutral-950">

    <div class="space-y-4" x-data="selectComponent" x-rover>
        <div class="w-[360px]">
            <div class="grid grid-cols-[auto_2rem] overflow-hidden">
                <input x-rover:input placeholder="Search..."
                    class="flex-1 col-start-1 col-span-full overflow-hidden row-start-1 w-full rounded-md bg-transparent py-2 text-neutral-300 placeholder-neutral-300 border border-neutral-500 px-4 focus:outline-none" />
                <button x-rover:button type="button" autocomplete="none"
                    class="col-start-2 row-start-1 border border-white/10 rounded-r-md text-white flex items-center self-center justify-center size-full">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
            </div>

            <ul x-rover:options x-cloak x-show="isOpen" style="display: none;"
                class="mt-1 max-h-60 w-full rounded-md border border-neutral-700 bg-white/5 text-white overflow-auto shadow-lg focus:outline-none">
                <li class="py-4 text-center" x-rover:empty>
                    No result found
                </li>

                <template x-for="(item, index) in items" x-bind:key="index">
                    <li x-rover:option x-bind:value="item" x-text="item.toUpperCase()"
                        class="px-4 data-selected:bg-red-500/10 data-active:!bg-white/10 py-2">
                    </li>
                </template>
            </ul>
        </div>
    </div>
</body>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('selectComponent', () => ({
            state: null,
            isOpen: false,
            isMultiple: false,
            items: [
                'tenjarine',
                'apple',
                'banana',
                'cherry',
                'orange',
                'mango',
                'grape'
            ],
            selected: 'mango',
            _previousSelected: undefined,

            init() {
                let inputManager = this.$rover.input;
                let optionsManager = this.$rover.options;

                inputManager.enableDefaultInputHandlers();
                optionsManager.enableDefaultOptionsHandlers();

                this.$watch('selected', (val) => {
                    console.log('Selected:', val);
                });

                inputManager.on('keydown', (event, activeValue) => {
                    if (event.key === 'Enter' && activeValue !== undefined) {
                        this.handleSelection(activeValue);
                        this.isMultiple || this.close();
                    }

                    if (event.key === "ArrowUp" || event.key === "ArrowDown") {
                        this.open();
                    }

                    if (event.key === "Escape") {
                        this.close();
                    }
                });

                inputManager.on('input', () => this.open());

                this.$rover.button.on('click', () => this.handleButtonClick());

                optionsManager.on('click', (event, closestOption) => {
                    if (closestOption !== undefined) {
                        const value = closestOption.dataset.value;
                        if (value) {
                            this.handleSelection(value);
                            this.isMultiple || this.close();
                        }
                    }
                });

                // diff based optimization to update selected and aria selectivity
                Alpine.effect(() => {
                    const selectedSet = new Set(
                        Array.isArray(this.selected) ? this.selected :
                            this.selected ? [this.selected] : []
                    );

                    const previousSet = this._previousSelected || new Set();
                    const toAdd = [...selectedSet].filter(v => !previousSet.has(v));
                    const toRemove = [...previousSet].filter(v => !selectedSet.has(v));

                    if (toAdd.length === 0 && toRemove.length === 0) return;

                    requestAnimationFrame(() => {
                        toAdd.forEach(value => {
                            const el = this.$rover.options.all.find(opt => opt.dataset.value === value);
                            if (el) {
                                el.setAttribute('aria-selected', 'true');
                                el.dataset.selected = 'true';
                            }
                        });

                        toRemove.forEach(value => {
                            const el = this.$rover.options.all.find(opt => opt.dataset.value === value);
                            if (el) {
                                el.setAttribute('aria-selected', 'false');
                                delete el.dataset.selected;
                            }
                        });
                    });

                    this._previousSelected = new Set(selectedSet);
                });
            },

            handleButtonClick() {
                this.isOpen = !this.isOpen;

                if (this.isOpen) {
                    this.activateSelectedOrFirst();
                }

                this.$refs._x__input?.focus();
            },

            open() {
                this.isOpen = true;
            },

            close() {
                this.isOpen = false;
            },

            handleSelection(value) {
                if (!this.isMultiple) {
                    // Single select
                    if (this.state === value) {
                        // Deselect
                        this.state = null;
                        this.selected = null;
                    } else {
                        // Select
                        this.state = value;
                        this.selected = value;
                    }

                    this.$refs._x__input.value = String(value).toUpperCase();
                } else {
                    // Multi-select
                    if (!Array.isArray(this.selected)) {
                        this.selected = [];
                    }

                    if (!Array.isArray(this.state)) {
                        this.state = [];
                    }

                    const index = this.state.indexOf(value);

                    if (index === -1) {
                        // Add to selection
                        this.state.push(value);
                        this.selected.push(value);
                    } else {
                        // Remove from selection
                        this.state.splice(index, 1);
                        this.selected.splice(index, 1);
                    }
                }
            },

            activateSelectedOrFirst(activateSelected = true) {
                let activeItem = this.$rover.getActiveItem();
                if (activeItem) return;

                if (activateSelected && this.selected) {
                    const valueToActivate = this.isMultiple
                        ? this.selected[0]
                        : this.selected;

                    if (valueToActivate) {
                        this.$rover.activate(valueToActivate);
                        return;
                    }
                }

                this.$rover.activateFirst();
            },
        }))
    })
</script>

</html>