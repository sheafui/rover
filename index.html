<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rover Plugin</title>


    <script src="./dist/cdn.js"></script>

    <link rel="icon" href="data:,">

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>

<body class="flex mt-20 justify-center bg-neutral-950">

    <div class="space-y-4" x-data="selectComponent" x-rover>
        <div class="w-[360px]">
            <div class="grid grid-cols-[auto_2rem] overflow-hidden">
                <input x-rover:input placeholder="Search..."
                    class="flex-1 col-start-1 col-span-full overflow-hidden row-start-1 w-full rounded-md bg-transparent py-2 text-neutral-300 placeholder-neutral-300 border border-neutral-500 px-4 focus:outline-none" />
                <button x-rover:button type="button"
                    class="col-start-2 row-start-1 border border-white/10 rounded-r-md text-white flex items-center self-center justify-center size-full">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
            </div>

            <ul x-rover:options x-cloak style="display: none;" x-show="isOpen"
                class="mt-1 max-h-60  w-full rounded-md border border-neutral-700 bg-white/5 text-white overflow-auto shadow-lg focus:outline-none">
                <li class="py-4 text-center" x-rover:empty>
                    No result found
                </li>

                <template x-for="(item, index) in items" x-bind:key="index">
                    <li x-rover:option="item" x-text="item"
                        class="px-4 data-selected:bg-red-500/10 data-active:!bg-white/10 py-2">
                    </li>
                </template>
            </ul>
        </div>
    </div>
</body>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('selectComponent', () => ({
            state: null,
            isOpen: false,
            isMultiple: false,
            items: ['tenjarine', 'apple', 'banana', 'cherry', 'orange', 'mango', 'grape'],
            selectedKeys: ['option-1'],

            init() {
                let inputManager = this.$rover.input;


                this.state = this.$rover.fromKeys(this.selectedKeys);

                inputManager.enableDefaultInputHandlers();

                let optionsManager = this.$rover.options;

                this.$watch('selectedKeys', (val) => {
                    console.log(val)
                });

                queueMicrotask(() => {
                    console.log(this.$rover.collection.getMap())
                })

                optionsManager.enableDefaultOptionsHandlers();

                inputManager.on('keydown', (event, activeKey) => {
                    if (event.key === 'Enter' && activeKey !== undefined) {
                        this.handleSelection(activeKey);

                        this.isMultiple || this.close();
                    }

                    if (event.key === "ArrowUp" || event.key === "ArrowDown") {
                        this.open();
                    }

                    if (event.key === "Escape") {
                        this.close();
                    }
                });

                inputManager.on('input', (_event, _activeKey) => this.open());

                this.$rover.button.on('click', (event) => this.handleButtonClick());

                // brainstorming the public APIs to work with
                optionsManager.on('click', (event, closestOption, activeKey) => {
                    if (closestOption !== undefined) {
                        this.handleSelection(closestOption.dataset.key);
                        this.isMultiple || this.close();
                    }
                });

                Alpine.effect(() => {
                    const selectedKeysSet = new Set(
                        Array.isArray(this.selectedKeys)
                            ? this.selectedKeys
                            : this.selectedKeys
                                ? [this.selectedKeys]
                                : []
                    );

                    this.$rover.options.all.forEach((optionEl) => {
                        const key = optionEl.dataset.key;
                        if (!key) return;

                        if (selectedKeysSet.has(key)) {
                            optionEl.setAttribute('data-selected', 'true');
                            optionEl.setAttribute('aria-selected', 'true');
                        } else {
                            optionEl.removeAttribute('data-selected');
                            optionEl.setAttribute('aria-selected', 'false');
                        }
                    });

                    this.state = this.$rover.fromKeys(this.selectedKeys)
                });

            },

            handleButtonClick() {
                this.isOpen != this.isOpen;

                if (this.isOpen) this.activateSelectedOrFirst();
            },

            open() {
                this.isOpen = true;
            },

            close() {
                this.isOpen = false;
            },

            handleSelection(key) {

                let value = this.__getValueByKey(key);

                if (!this.isMultiple) {
                    this.selectedKeys = key;

                    if (this.state === value) {
                        this.state = null;
                        this.selectedKeys = null;
                    } else {
                        this.state = value;
                    }

                    this.$refs.__input.value = String(value).toUpperCase();

                    return;
                }

                if (!Array.isArray(this.selectedKeys)) {
                    this.selectedKeys = [];
                }

                if (!Array.isArray(this.state)) {
                    this.state = [];
                }

                let index = this.state.indexOf(value);

                let keyIndex = this.selectedKeys.indexOf(key);

                if (index === -1) {
                    this.state.push(value);
                    this.selectedKeys.push(key);
                } else {
                    this.state.splice(index, 1);
                    this.selectedKeys.splice(keyIndex, 1);
                }
            },

            activateSelectedOrFirst(activateSelected = true) {
                if (!this.$rover.isOpen) return;

                let activeItem = this.$rover.getActiveItem();

                if (activeItem) return;

                if (activateSelected && this.selectedKeys) {
                    const keyToActivate = this.isMultiple
                        ? this.selectedKeys[0]
                        : this.selectedKeys;

                    if (keyToActivate) {
                        this.$rover.activate(keyToActivate);
                        return;
                    }
                }

                this.$rover.activateFirst();
            },
        }))
    })
</script>

</html>