<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rover Plugin - Stress Test</title>

    <script src="./dist/cdn.js"></script>
    <link rel="icon" href="data:,">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>

<body class="bg-neutral-950 text-white">
    
    <!-- Performance Dashboard -->
    <div class="p-4 bg-neutral-900 border-b border-neutral-700">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <h1 class="text-xl font-bold">Rover Stress Test</h1>
            <div class="flex gap-2">
                <button @click="setItemCount(10)" 
                        class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm">
                    10 items
                </button>
                <button @click="setItemCount(100)" 
                        class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm">
                    100 items
                </button>
                <button @click="setItemCount(500)" 
                        class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-sm">
                    500 items
                </button>
                <button @click="setItemCount(1000)" 
                        class="px-3 py-1 bg-orange-600 hover:bg-orange-700 rounded text-sm">
                    1,000 items
                </button>
                <button @click="setItemCount(5000)" 
                        class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm">
                    5,000 items
                </button>
                <button @click="setItemCount(10000)" 
                        class="px-3 py-1 bg-red-800 hover:bg-red-900 rounded text-sm">
                    10,000 items
                </button>
            </div>
        </div>
        <div class="max-w-6xl mx-auto mt-2 text-sm text-neutral-400">
            Current items: <span class="text-white font-bold" x-text="items.length"></span> | 
            Selected: <span class="text-white" x-text="selected || 'none'"></span>
        </div>
    </div>

    <div class="flex mt-20 justify-center">
        <div class="space-y-4" x-data="selectComponent" x-rover>
            <div class="w-[360px]">
                <div class="grid grid-cols-[auto_2rem] overflow-hidden">
                    <input x-rover:input placeholder="Search..."
                        class="flex-1 col-start-1 col-span-full overflow-hidden row-start-1 w-full rounded-md bg-transparent py-2 text-neutral-300 placeholder-neutral-300 border border-neutral-500 px-4 focus:outline-none" />
                    <button x-rover:button type="button"
                        class="col-start-2 row-start-1 border border-white/10 rounded-r-md text-white flex items-center self-center justify-center size-full">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="size-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                </div>

                <ul 
                    x-rover:options 
                    x-cloak 
                    x-show="isOpen"
                    style="display: none;" 
                    class="mt-1 max-h-96 w-full rounded-md border border-neutral-700 bg-white/5 text-white overflow-auto shadow-lg focus:outline-none">
                    <li class="py-4 text-center" x-rover:empty>
                        No result found
                    </li>

                    <template x-for="(item, index) in items" x-bind:key="index">
                        <li 
                            x-rover:option 
                            x-bind:value="item"
                            class="px-4 data-selected:bg-red-500/10 data-active:!bg-white/10 py-2 border-b border-neutral-800">
                            <div class="flex justify-between items-center">
                                <span x-text="item"></span>
                                <span class="text-xs text-neutral-500" x-text="'#' + (index + 1)"></span>
                            </div>
                        </li>
                    </template>
                </ul>
            </div>

            <!-- Instructions -->
            <div class="w-[360px] p-4 bg-blue-900/20 border border-blue-700 rounded text-xs">
                <div class="font-bold mb-2">ðŸ’¡ Test Instructions:</div>
                <ul class="space-y-1 text-neutral-300">
                    <li>â€¢ Use â†‘â†“ arrow keys to navigate</li>
                    <li>â€¢ Type to search/filter</li>
                    <li>â€¢ Press Enter to select</li>
                    <li>â€¢ Watch for lag with 5k+ items</li>
                </ul>
            </div>
        </div>
    </div>
</body>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('selectComponent', () => ({
            state: null,
            isOpen: false,
            isMultiple: false,
            items: [],
            selected: null,

            init() {
                // Start with 100 items
                this.setItemCount(100);

                let inputManager = this.$rover.input;
                let optionsManager = this.$rover.options;

                inputManager.enableDefaultInputHandlers();
                optionsManager.enableDefaultOptionsHandlers();

                this.$watch('selected', (val) => {
                    console.log('Selected:', val);
                });

                inputManager.on('keydown', (event, activeValue) => {
                    if (event.key === 'Enter' && activeValue !== undefined) {
                        this.handleSelection(activeValue);
                        this.isMultiple || this.close();
                    }

                    if (event.key === "ArrowUp" || event.key === "ArrowDown") {
                        this.open();
                    }

                    if (event.key === "Escape") {
                        this.close();
                    }
                });

                inputManager.on('input', () => this.open());

                this.$rover.button.on('click', () => this.handleButtonClick());

                optionsManager.on('click', (event, closestOption) => {
                    if (closestOption !== undefined) {
                        const value = closestOption.dataset.value;
                        if (value) {
                            this.handleSelection(value);
                            this.isMultiple || this.close();
                        }
                    }
                });

                Alpine.effect(() => {
                    const selectedSet = new Set(
                        Array.isArray(this.selected)
                            ? this.selected
                            : this.selected
                                ? [this.selected]
                                : []
                    );

                    // Batch DOM writes 
                    this.$rover.options.all.forEach((optionEl) => {
                        const value = optionEl.dataset.value; 
                        if (!value) return;

                        if (selectedSet.has(value)) {
                            optionEl.setAttribute('data-selected', 'true');
                            optionEl.setAttribute('aria-selected', 'true');
                        } else {
                            optionEl.removeAttribute('data-selected');
                            optionEl.setAttribute('aria-selected', 'false');
                        }
                    });
                });
            },

            // Generate items dynamically
            setItemCount(count) {
                console.time(`Generate ${count} items`);
                
                const fruits = ['Apple', 'Banana', 'Cherry', 'Orange', 'Mango', 'Grape', 'Peach', 'Pear', 'Plum', 'Kiwi'];
                const adjectives = ['Red', 'Green', 'Yellow', 'Sweet', 'Sour', 'Fresh', 'Ripe', 'Juicy', 'Organic', 'Local'];
                
                this.items = [];
                
                for (let i = 0; i < count; i++) {
                    const fruit = fruits[i % fruits.length];
                    const adjective = adjectives[Math.floor(i / fruits.length) % adjectives.length];
                    const suffix = count > 100 ? ` ${i + 1}` : '';
                    this.items.push(`${adjective} ${fruit}${suffix}`);
                }
                
                console.timeEnd(`Generate ${count} items`);
                console.log(`âœ… Generated ${count} items`);

                // Reset selection
                this.selected = null;
                this.state = null;
                this.isOpen = false;
            },

            handleButtonClick() {
                this.isOpen = !this.isOpen;

                if (this.isOpen) {
                    this.activateSelectedOrFirst();
                }

                this.$refs._x__input?.focus();
            },

            open() {
                this.isOpen = true;
            },

            close() {
                this.isOpen = false;
            },

            handleSelection(value) {
                if (!this.isMultiple) {
                    if (this.state === value) {
                        this.state = null;
                        this.selected = null;
                    } else {
                        this.state = value;
                        this.selected = value;
                    }

                    this.$refs._x__input.value = String(value);
                } else {
                    if (!Array.isArray(this.selected)) {
                        this.selected = [];
                    }

                    if (!Array.isArray(this.state)) {
                        this.state = [];
                    }

                    const index = this.state.indexOf(value);

                    if (index === -1) {
                        this.state.push(value);
                        this.selected.push(value);
                    } else {
                        this.state.splice(index, 1);
                        this.selected.splice(index, 1);
                    }
                }
            },

            activateSelectedOrFirst(activateSelected = true) {
                let activeItem = this.$rover.getActiveItem();
                if (activeItem) return;

                if (activateSelected && this.selected) {
                    const valueToActivate = this.isMultiple
                        ? this.selected[0]  
                        : this.selected;    

                    if (valueToActivate) {
                        this.$rover.activate(valueToActivate);
                        return;
                    }
                }

                this.$rover.activateFirst();
            },
        }))
    })
</script>

</html>